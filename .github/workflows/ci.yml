name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    name: "ESP-IDF ${{ matrix.idf_version }}"
    runs-on: ubuntu-latest
    container:
      image: "espressif/idf:${{ matrix.idf_version }}"
    continue-on-error: ${{ matrix.allow_failure }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - idf_version: v5.5.2
            allow_failure: false
          - idf_version: release-v6.0
            allow_failure: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install QEMU
        run: |
          python $IDF_PATH/tools/idf_tools.py install qemu-xtensa
          eval "$(python $IDF_PATH/tools/idf_tools.py export)"
          qemu-system-xtensa --version

      - name: Build and run tests
        working-directory: test_app
        run: |
          . $IDF_PATH/export.sh
          eval "$(python $IDF_PATH/tools/idf_tools.py export)"
          chmod +x run_tests.sh
          ./run_tests.sh
